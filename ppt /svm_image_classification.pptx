import os
import cv2
import numpy as np
import matplotlib.pyplot as plt
import seaborn as sns
import joblib
import pandas as pd
from sklearn.model_selection import train_test_split, GridSearchCV
from sklearn.svm import SVC
from sklearn.metrics import accuracy_score, confusion_matrix

# Step 1: Set working directory and paths
os.chdir("C:\\Users\\Manisha\\Downloads\\cst600-week04-svm-images-pavan")
print("Current working directory:", os.getcwd())

data_dir = os.path.join(os.getcwd(), "data", "raw")
benign_path = os.path.join(data_dir, "benign")
malignant_path = os.path.join(data_dir, "malignant")

# Step 2: Load and preprocess images
def load_images(folder, label, size=(64, 64)):
    data = []
    for filename in os.listdir(folder):
        path = os.path.join(folder, filename)
        img = cv2.imread(path, cv2.IMREAD_GRAYSCALE)
        if img is not None:
            img = cv2.resize(img, size)
            data.append((img.flatten(), label))
    return data

benign_data = load_images(benign_path, 0)
malignant_data = load_images(malignant_path, 1)

# Step 3: Prepare dataset
all_data = benign_data + malignant_data
X = np.array([item[0] for item in all_data])
y = np.array([item[1] for item in all_data])

# Step 4: Split into train/test
X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2, random_state=42)

# Step 5: Train SVM
model = SVC(kernel='linear')
model.fit(X_train, y_train)

# Step 6: Evaluate
y_pred = model.predict(X_test)
print("Accuracy:", accuracy_score(y_test, y_pred))
print("Confusion Matrix:\n", confusion_matrix(y_test, y_pred))

# Step 7: Plot confusion matrix
plt.figure(figsize=(6, 4))
sns.heatmap(confusion_matrix(y_test, y_pred), annot=True, fmt='d', cmap='Blues')
plt.title("Confusion Matrix")
plt.xlabel("Predicted")
plt.ylabel("Actual")
plt.savefig("figures/confusion_matrix.png")
plt.show()

# Step 8: Predict new image
def predict_image(path, model, size=(64, 64)):
    img = cv2.imread(path, cv2.IMREAD_GRAYSCALE)
    img = cv2.resize(img, size)
    img_flat = img.flatten().reshape(1, -1)
    prediction = model.predict(img_flat)
    return "Malignant" if prediction[0] == 1 else "Benign"

# Example usage
new_image_path = "data/raw/benign/sample1.jpg"  # Replace with a real image
result = predict_image(new_image_path, model)
print("Prediction for new image:", result)

# Step 9: Save model
joblib.dump(model, "svm_model.pkl")

# Step 10: Visualize predictions
for i in range(5):
    img = X_test[i].reshape(64, 64)
    label = y_pred[i]
    plt.imshow(img, cmap='gray')
    plt.title("Predicted: " + ("Malignant" if label == 1 else "Benign"))
    plt.axis('off')
    plt.show()

# Step 11: Hyperparameter tuning
param_grid = {
    'C': [0.1, 1, 10],
    'kernel': ['linear', 'rbf', 'poly'],
    'gamma': ['scale', 'auto']
}
grid = GridSearchCV(SVC(), param_grid, cv=5)
grid.fit(X_train, y_train)
print("Best parameters:", grid.best_params_)
print("Best score:", grid.best_score_)

# Step 12: Export predictions
df = pd.DataFrame({
    "Actual": y_test,
    "Predicted": y_pred
})
df.to_csv("svm_predictions.csv", index=False)
